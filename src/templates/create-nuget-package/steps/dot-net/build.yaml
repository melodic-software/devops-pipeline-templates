steps:
  - task: PowerShell@2
    name: PrepareBuildArguments
    displayName: Prepare Build Arguments
    condition: succeeded()
    inputs:
      targetType: "inline"
      script: |
        $SignAssembly = [System.Convert]::ToBoolean("$(SignAssembly)")
        $AssemblyOriginatorKeyFile = "$(AssemblyOriginatorKeyFile)"

        # Initialize with static values.
        $BuildArguments = "--configuration $(BuildConfiguration) --no-restore"

        # https://learn.microsoft.com/en-us/azure/devops/pipelines/artifacts/caching-nuget?view=azure-devops
        # https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files
        # https://devblogs.microsoft.com/nuget/enable-repeatable-package-restores-using-a-lock-file
        # TODO: This will have to be enabled if attempting to use pipeline cache for NuGet packages with .NET Framework projects.
        # This property could alternatively be enabled in a Directory.Build.props file or the .csproj itself.
        #$BuildArguments += " -p:RestoreLockedMode=true"

        # The following are dynamic properties.

        if ($SignAssembly) {
          $BuildArguments += " /p:SignAssembly=true"
          
          if (-not [string]::IsNullOrEmpty($AssemblyOriginatorKeyFile)) {
            $BuildArguments += " /p:AssemblyOriginatorKeyFile=$AssemblyOriginatorKeyFile"
          } else {
            Write-Warning "SignAssembly is true but AssemblyOriginatorKeyFile has not been provided. Assembly signing may fail."
          }
        } elseif (-not [string]::IsNullOrEmpty($AssemblyOriginatorKeyFile)) {
          Write-Warning "AssemblyOriginatorKeyFile is provided but SignAssembly is false. The key file will be ignored."
        }

        Write-Host "Build arguments: $BuildArguments"
        Write-Host "##vso[task.setvariable variable=BuildArguments]$BuildArguments"
      pwsh: true

  - task: DotNetCoreCLI@2
    name: BuildDotNet
    displayName: Build Project
    inputs:
      command: "build"
      projects: "**/$(ProjectName).csproj"
      arguments: $(BuildArguments)