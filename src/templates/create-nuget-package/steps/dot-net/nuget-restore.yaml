parameters:
  useNuGetCache: true
  clearNuGetCache: false

steps:
  # https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/nuget-authenticate-v1?view=azure-pipelines
  - task: NuGetAuthenticate@1
    name: NuGetAuthenticate
    displayName: NuGet Authenticate
    condition: succeeded()

  # NuGet.config should exist in the source repository root, but this isn't guaranteed.
  - task: PowerShell@2
    name: SetNuGetRestoreSettings
    displayName: Set NuGet Restore Settings
    condition: succeeded()
    continueOnError: true
    inputs:
      targetType: "inline"
      script: |
        $NuGetConfigFile = Get-ChildItem -Path "$(SelfRepositoryFolder)" -Filter NuGet.config -Recurse | Select-Object -First 1
        if ($NuGetConfigFile) {
            $FullPath = $NuGetConfigFile.FullName
            Write-Host "Found NuGet.config at $FullPath"
            echo "##vso[task.setvariable variable=NuGetConfigPath]$FullPath"
            echo "##vso[task.setvariable variable=FeedsToUse]config"
        } else {
            Write-Host "No NuGet.config found. Using default configuration."
            echo "##vso[task.setvariable variable=FeedsToUse]select"
        }
      pwsh: true

  - ${{ if and(eq(parameters.useNuGetCache, true), ne(parameters.clearNuGetCache, true)) }}:
      - template: ../../../shared/steps/nuget-cache.yaml

  - ${{ if eq(parameters.clearNuGetCache, true) }}:
      - template: ./nuget-clear-cache.yaml

  - task: PowerShell@2
    name: DebugCacheHit
    displayName: "Debug Cache Hit"
    inputs:
      targetType: "inline"
      script: |
        Write-Host "NuGetCacheRestored: $(NuGetCacheRestored)"
    pwsh: true

  - task: DotNetCoreCLI@2
    name: NuGetRestoreDotNet
    displayName: NuGet Restore
    condition: ne(variables.NuGetCacheRestored, true)
    inputs:
      command: restore
      #projects: $(SelfRepositoryFolder)/**/*.csproj
      projects: |
        $(SelfRepositoryFolder)/**/$(ProjectName).csproj
        $(TestProjects)
      feedsToUse: $(FeedsToUse)
      nugetConfigPath: $(NuGetConfigPath)
      # https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-restore
      #restoreArguments: '--locked-mode' # Required for NuGet package caching
      restoreDirectory: $(NuGetRestoreDirectory)
      #noCache: true
